# RM2020哨兵视觉协议 v2.2

by ThunderDoge 更新到2020-4-15

## 链路层配置

**1位起始位 ８位数据位 0奇偶校验位 1停止位 波特率460800**

## 应用层协议

协议数据结构　**总长度18位**

| 帧首 | 功能字 | 数据 | 和检验 | 帧尾 |
| ---- | ------ | ---- | ------ | ---- |
| 0XFF | １位   | 14位 | 1位    | 0X0D |

说明：**和检验为其他位(包括帧头帧尾)的和&0XFF**，数据位为使用**memcpy**直接进行的数据拷贝,取出时应使用相同方式。

## 视觉发:	//0x01开始

1. 控制云台相对角度，功能字0x01

| 帧首 | 功能字 | pitch | yaw   | 云台转动模式 | 射击模式 | 补零 | 和检验 | 帧尾 |
| ---- | ------ | ----- | ----- | ------------ | -------- | ---- | ------ | ---- |
| 0XFF | 0x01   | float | float | uint8_t      | uint8_t  | 4位  | 1位    | 0X0D |

2. 控制云台绝对角度，功能数字0x02

| 帧首 | 功能字 | pitch | yaw   | 云台转动模式 | 射击模式 | 补零 | 和检验 | 帧尾 |
| ---- | ------ | ----- | ----- | ------------ | -------- | ---- | ------ | ---- |
| 0XFF | 0x02   | float | float | uint8_t      | uint8_t  | 4位  | 1位    | 0X0D |

3. 射击，功能字0x03

| 帧首 | 功能字 | 射速  | 射频    | 射击模式 | 补零 | 和检验 | 帧尾 |
| ---- | ------ | ----- | ------- | -------- | ---- | ------ | ---- |
| 0XFF | 0x03   | float | uint8_t | uint8_t  | 8位  | 1位    | 0X0D |

下面是**哨兵移动指令**。请注意：【一般移动（底盘控制、底盘控制路程、哨兵底盘控制路程,速度限制）】、【闪避】、【撞柱】是互斥的，发送互斥的命令会覆盖之前的命令，并执行新的命令。除了【撞柱】的开始撞柱阶段，它允许覆盖命令，但只能执行完撞柱之后才能执行下一个。

4. 底盘控制速度，功能字0x04

| 帧首 | 功能字 | V_x   | V_y   | 补零 | 和检验 | 帧尾 |
| ---- | ------ | ----- | ----- | ---- | ------ | ---- |
| 0XFF | 0x04   | float | float | 6位  | 1位    | 0X0D |

5. 底盘控制路程，功能字0x05

   | 帧首 | 功能字 | P_x   | P_y   | 补零 | 和检验 | 帧尾 |
   | ---- | ------ | ----- | ----- | ---- | ------ | ---- |
   | 0XFF | 0x05   | float | float | 6位  | 1位    | 0X0D |

6. 哨兵底盘控制路程,速度限制,功能0x06

| 帧首 | 功能字 | 相对位置 | 速度限制 | 补零 | 和检验 | 帧尾 |
| ---- | ------ | -------- | -------- | ---- | ------ | :--- |
| 0XFF | 0x06   | float    | float    | 6位  | 1位    | 0X0D |

7. **新增**闪避：命令哨兵进行闪避。功能字0x07

   【闪避】相当于是，哨兵随机的选取轨道上的一系列位置，进行【底盘控制路程】的操作，此过程可选【允许/不允许】消耗缓冲能量。

   此模式启用需要连续发送，发送间隔小于100ms。停发自动停用。
   
   启用中会不停进行闪避，直至缓冲能量耗尽。闪避过程任意时刻可取消。

   

8. **新增**撞柱：命令哨兵进行撞柱。功能字0x08

   发送一次启动撞柱。哨兵会先航行到撞柱预备位置（此阶段可以取消），然后开始撞柱（此阶段不可取消）。撞柱状态。

9. **新增**查询/修改某PID参数。功能字0X10

   请注意小主机只能查看/设定自己的**串口直接连接的云台**的参数。

   1. 查询

   | 帧首 | 功能字 | 需查询PID编号    | 补零 | 和检验 | 帧尾 |
   | ---- | ------ | ---------------- | ---- | ------ | ---- |
   | 0XFF | 0X07   | uint8_t 取值见下 |      | 1位    | 0X0D |

   返回值

   | 功能字 | 需查询PID编号    | P       | I       | D       |
   | ------ | ---------------- | ------- | ------- | ------- |
   | 0X07   | uint8_t 取值见下 | float P | float I | float D |

   

   2. 修改

   | 帧首 | 功能字 | 需修改PID编号    | P       | I       | D       | 补零 | 和检验 | 帧尾 |
   | ---- | ------ | ---------------- | ------- | ------- | ------- | ---- | ------ | ---- |
   | 0XFF | 0X08   | uint8_t 取值见下 | float P | float I | float D |      | 1位    | 0X0D |

   返回值

   | 功能字 | 需查询PID编号    | P       | I       | D       |
   | ------ | ---------------- | ------- | ------- | ------- |
   | 0X07   | uint8_t 取值见下 | float P | float I | float D |

PID编号表

​		

| PID名           | 编号 |
| --------------- | ---- |
| 云台PITCH位置环 | 1    |
| 云台PITCH速度环 | 2    |
| 云台YAW位置环   | 3    |
| 云台YAW速度环   | 4    |



## 电控发:	//0x11开始

1. 云台状态，功能字0x11，目前间隔5MS发一帧

| 帧首 | 功能字 | 控制模式 | pitch | yaw   | 射速  | 补零 | 和检验 | 帧尾 |
| ---- | ------ | -------- | ----- | ----- | ----- | ---- | ------ | ---- |
| 0XFF | 0x11   | uint8_t  | float | float | float | 1位  | 1位    | 0X0D |
2. **更新** 底盘信息，功能字0x13，与云台状态一起发

| 帧首 | 功能字 | 控制模式 | 到柱          | 绝对位置 | 动作状态      | 补零 | 和检验 | 帧尾 |
| ---- | ------ | -------- | ------------- | -------- | ------------- | ---- | ------ | ---- |
| 0XFF | 0x12   | uint8_t  | unsigned char | float    | unsigned char | 9位  | 1位    | 0X0D |

动作状态指示：0=一般运动；1=闪避；2=撞柱预备；3=撞柱已开始

3. 日志系统，功能字0x12，有异常的时候才会发。（目前未实现）

| 帧首 | 功能字 | 异常编号     | 具体内容                                          | 和校验 | 帧尾 | 日志内容         |
| ---- | ------ | ------------ | ------------------------------------------------- | ------ | ---- | ---------------- |
| 0XFF | 0x12   | int8_t  0x01 | 补零                                              | 1位    | 0X0D | Dbus离线         |
| 0XFF | 0x12   | int8_t  0x02 | 补零                                              | 1位    | 0X0D | CAN1离线         |
| 0XFF | 0x12   | int8_t  0x03 | 补零                                              | 1位    | 0X0D | CAN2离线         |
| 0XFF | 0x12   | int8_t  0x04 | int16_t CAN1电机离线数据 int16_t CAN2电机离线数据 | 1位    | 0X0D | 具体离线电机检测 |
| 0XFF | 0x12   | int8_t  0x05 | 补零                                              | 1位    | 0X0D | 云台失联         |
| 0XFF | 0x12   | int8_t  0x06 | 补零                                              | 1位    | 0X0D | 底盘失联         |
| 0XFF | 0x12   | int8_t  0x07 | 补零                                              | 1位    | 0X0D | 裁判系统失联     |
| 0XFF | 0x12   | int8_t  0x08 | 补零                                              | 1位    | 0X0D | 设备自主重启     |

## 电控发：裁判系统信息 //0x21开始

| 信息类型               | 功能字 | 数据类型                                                     | 注释                                                         | 发送时机               |
| ---------------------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------- |
| 机器人状态.血量        | 0x21   | uint16_t remain_HP                                           |                                                              | 裁判系统触发发送，10Hz |
| 蓝方机器人血量数据     | 0x22   | uint16_t[7]=蓝方[1,2,3,4,5,7,基地]血量                       |                                                              | 1Hz                    |
| 红方机器人血量数据     | 0x23   | uint16_t[7]=红放[1,2,3,4,5,7,基地]血量                       |                                                              | 1Hz                    |
| 实时功率和枪口热量数据 | 0x24   | float chassis_power,uint16_t chassis_power_buffer,uint16_t shooter_heat0 |                                                              | 裁判系统触发发送，50hz |
| 机器人增益             | 0x25   | uint8_t power_rune_buff                                      | bit 0：机器人血量补血状态 <br/>bit 1：枪口热量冷却加速 <br/>bit 2：机器人防御加成 <br/>bit 3：机器人攻击加成 | 裁判系统触发发送       |
| 伤害状态               | 0x26   | uint8_t armor_id : 4; uint8_t hurt_type : 4;uint16_t remain_HP | hurt_type:0=装甲伤害;1=模块掉线;2=超子弹初速;3=超枪口热量;4=超底盘功率;5=装甲撞击扣血 | 裁判系统触发发送       |
| 子弹剩余数目           | 0x28   | uint16_t bullet_remaining_num;                               |                                                              | 1Hz                    |
| 交互数据接收信息       | 0x31   | 保留备用                                                     |                                                              |                        |



| 信息类型         | 功能字 | 数据类型                                                     | 使用方式                                                     |
| ---------------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 比赛状态数据     | 0x20   | uint8_t game_progress<br>uint16_t stage_remain_time          | 启动巡逻<br>根据剩余时间决定射击速度                         |
| 机器人血量数据   | 0x21   | uint16_t                                                     | 根据敌方血量等级信息确定攻击的优先级                         |
| 场地事件数据     | 0x22   | uint32_t                                                     | 待定(有可能会更新前哨站的信息，去年没有)                     |
| 比赛机器人状态   | 0x23   | uint16_t remain_HP                                           | 快速读取自己的剩余血量                                       |
| 实时功率热量数据 | 0x24   | float chassis_power<br>uint16_t chassis_power_buffer<br>uint16_t shooter_heat0 | 算法层防止超功率,根据功率使用情况更改躲避策略,通过枪口热量计算开枪时间 |
| 机器人增益       | 0x25   | uint8_t power_rune_buff                                      | 待定                                                         |
| 伤害状态         | 0x26   | uint8_t armor_id : 4;<br/>uint8_t hurt_type : 4;             | 根据装甲板id确定敌方位置<br>                                 |
| 实时射击信息     | 0x27   | uint8_t bullet_freq;<br/>float bullet_speed;                 | 根据射速不同判断打出去了多少发子弹(上一届做法)，这里主要是电控层用的较多 |
| 子弹剩余发射数   | 0x28   | uint16_t bullet_remaining_num;                               | 矫正剩余子弹数目                                             |
| 交互数据接收信息 | 0x31   |                                                              | 用于进行进行人工干预,例如前哨站没了无敌解除                  |

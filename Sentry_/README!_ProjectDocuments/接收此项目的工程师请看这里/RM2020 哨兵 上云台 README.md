# RM2020 哨兵 上云台 电控工程 README

by Thunderdoge, 2020-2-28

[TOC]



## 已实现的功能及性能指标

- 物理功能
  - Yaw电机最大匀速转速【r/s】，半圆周响应0.5r~【s】
  - Pitch电机，90°响应【s】。电机长时工作温度稳定在70℃左右. 水平电流输出【6500】:warning:请控制电机使用时间
  - 瞄准能力
    - YAW轴任意角度旋转，PITCH俯角≈25°，仰角约等于70°。有机械限位。
    - PITCH和YAW保证在任何角度不抖动。（一般发生在位置环以电机编码器作为反馈时）
    - 为了实现上一条，能在 位置环： 机械角反馈-陀螺仪反馈 之间无缝切换。实际使用是在一些角度（可能产生抖动的）采用陀螺仪反馈，其他角度采用机械角反馈。
    - 45°以内阶跃响应
      - 5%收敛：【s】
      - 1%收敛：【s】
    - 容许静差：不大于【3】个编码器精度
  - 红色激光器
  - 发射机构，摩擦轮
    - 电机【7000转】，双轮差速小于【x%】。单发最大初速【m/s】
    - 单发导致的电机转速谷值【转】。连续射击平均初速【m/s】
    - 弹道散步参数见弹道组图表。
- 通信功能
  - 与小主机使用UART通信 【460800bsp - 8bit - NoParity】
    - 中断接收并处理UART数据
    - 可以正常接收处理长为【3】帧的连续数据帧。超出的部分会被忽略。
    - 连续数据帧之间的间隔至少为【2ms】以保证正常接收。
    - 发送速率500Hz
  - 与其他板子使用CAN进行通信【1Mbsp , 标准ID，Cube.TimeQuantum配置: 3-9-1】
    - CAN2
    - 发送速率500Hz
    - 各部位物理信息广播(ID= xx_State)
    - 各部设备离线状态广播(ID=OFFLINE_LIST)
    - 上级命令广播(ID=SUPERCON_xx)
  - 与DJI电机通过CAN通信并控制它们。【1Mbsp , 标准ID，Cube.TimeQuantum配置: 3-9-1】
    - CAN1 - 摩擦轮*2、拨弹、YAW / PITCH
    - 控制频率1K（符合官方设定）
    - :warning: 最大同一CAN网络上5个电机。更多设备将出现丢帧，导致控制延时。
  - SPI获取陀螺仪数据(1K速率)
- 人机交互
  - 遥控器调试模式：手动云台调试，小主机控制测试，手动底盘调试、摩擦轮射击测试。
  - （哨兵全系统）自诊断系统：OLED屏幕：全机体设备离线状态报告。
- 鲁棒性设计
  - 失去板间CAN连接情况下，云台能够独立运作。（其实是进入安全模式）
  - 检测到本云台相连的小主机离线，会尝试通知另一小主机指挥。

## 使用说明（参数设置方法）

参数分布在各个文件，大部分采用宏定义形式。于此汇总部分常用的。详细请食用源代码（有注释）。

### 通信

- 视觉小主机
  - 宏定义 `BSP_VISION_UART` 与小主机通信使用的串口的hal句柄 `huartx`
  - 宏定义 `BSP_VISION_BUFFER_SIZE` 一次性能接收字节数。注：18字节是一个数据帧长度。
- 电机CAN通信
- MCU间通信
  - 宏定义 `CAN_INTERBOARD` 表示MCU间通信使用的CAN号。定义在[Cloud/Chassis]Can.h

## 逻辑结构概述

这是哨兵上云台电控工程说明文档。本文件应当存在于`Sentry.h`中这也是哨兵电控逻辑开始的地方。

哨兵上云台工程使用Cube建立，并使用了FreeRTOS。

除了Cube默认生成的库文件之外，本工程依赖的其他文件的路径：(`./`表示工程所在目录，即`.uvprojx`文件所在目录)

- `./MDK-ARM/Sentry` Files for 哨兵上云台 only
- `../CommomForSentry` 哨兵各个MCU通用文件
  - `../CommomForSentry/Bsp`板级支持包，即硬件相关的文件
  - `../CommomForSentry/App`应用，依赖于Bsp
  - `../CommomForSentry/AppSentry`哨兵专属应用，依赖于App和Bsp
  - `../CommomForSentry/Motor`DJI电机控制相关Bsp, App聚合

## 关键部位说明

### SentryCloud CloudEntity

`class SentryCloud`是哨兵云台物理实体类，包含所有电机 和激光器的操作的方法和云台物理信息。

需要操作拨弹电机的话必须使用SentryCloud`提供的函数Feed_xxx_Set(). 这是为了安全考虑，将AmmoFeed的一部分操作函数设为protected，防止错误调用。只有友元SentryCloud可以使用。

SentryCloud的成员包含云台的电机对象（名字带motor），电机对象的pid（名字pid起头），以及其他信息。你可以注意到PID有两套，带Gyro的是给 位置环：陀螺仪反馈 使用的，没有Gyro是编码器反馈。两套的参数不同，应该已经调至效果差不多。切换模式时。

